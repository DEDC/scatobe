{% extends "base/base.html" %}

{% block title %}Administrador{% endblock title %}

{% block body %}
<form action="{% url 'usuarios:descarga_factura' %}" method="post" id="f_factura" target="_blank" >
    {% csrf_token %}
    <input type="hidden" name="f_anio">
    <input type="hidden" name="f_mes">
</form>
<div id="modal-example" uk-modal>
    <div class="uk-modal-dialog">
        <button class="uk-modal-close-default" type="button" uk-close></button>
        <div class="uk-modal-header">
            <h2 class="uk-modal-title">Nueva solicitud</h2>
        </div>
        <div class="uk-modal-body">
            <form action="{% url 'usuarios:rSolicitudes' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <p>
                    <label for="id_fecha">Fecha:</label>
                    {{rSolicitudes.fecha}}
                </p>
                <p>
                    <label for="id_folio">Folio:</label>
                    {{rSolicitudes.folio}}
                </p>
                <p>
                    <label for="id_post">Post:</label>
                    {{rSolicitudes.post}}
                </p>
                <p>
                    <label for="id_link">Link:</label>
                    {{rSolicitudes.link}}
                </p>
                <p>
                    <label for="id_zona">Zonas:</label>
                    {{rSolicitudes.zona}}
                </p>
                <p>
                    <label for="id_categoria">Categorías:</label>
                    {{rSolicitudes.categoria}}
                </p>
                <p>
                    <label for="id_tipo">Tipo:</label>
                    {{rSolicitudes.tipo}}
                </p>
                <p>
                    <label for="id_fanPage">FanPages:</label>
                    <select name="fanPage" id="id_fanPage" required></select>
                </p>
                <p>
                    <label for="id_gerente">Gerentes:</label>
                    <select name="gerente" id="id_gerente" required></select>
                </p>
                {{rImagenes.as_p}}
                {{rMateriales.as_p}}
                <button type="submit">Guardar</button>
            </form>
        </div>
        <!-- <div class="uk-modal-footer uk-text-right"> -->
        <!-- <button class="uk-button uk-button-default uk-modal-close" type="button">Cancelar</button> -->
        <!-- <button class="uk-button uk-button-primary" type="button">Guardar</button> -->
        <!-- </div> -->
    </div>
</div>
{% endblock body %}

{% block mesReferencia %}
ABRIL
{% endblock mesReferencia %}

{% block publicacionesTotales %}
{{solicitudes.count}}
{% endblock publicacionesTotales %}

{% block zonalbox %}
{% for zona in zonas %}
<div class="zonal1">{{zona}} <div class="numerozona"><i class="fas fa-caret-right"></i> {{zona.soli_zona.count}}</div>
</div>
{% endfor %}
{% endblock zonalbox %}

{% block menu %}
<div class="boton" uk-toggle="target: #modal-example"><i class="fas fa-plus"></i>&nbsp;&nbsp;AGREGAR</div>
<div class="boton" data-post="{% url 'usuarios:descarga_pdf' %}" id="makePdf"><i class="far fa-file-pdf"></i>&nbsp;&nbsp;GENERAR PDF</div>
<div class="boton" id="download-factura"><i class="fas fa-file-invoice-dollar"></i>&nbsp;&nbsp;DESCARGAR FACTURA</div>
<div class="boton"><a href="{% url 'usuarios:formularios' %}"><i class="fas fa-cog"></i>&nbsp;&nbsp;CONFIGURACIONES</a>
</div>
<div class="boton"><a href="{% url 'usuarios:logout' %}"><i class="fas fa-sign-out-alt"></i>&nbsp;&nbsp;SALIR</a></div>
{% endblock menu %}

{% block tablaDetalles %}
<!-- tabla 01 ---------------------------------------->
<table align="center" cellspacing="0" id="admin">
    <thead>
        <tr>
            <th width="050"><input id="checkAll" type="checkbox"></th>
            <th width="110">Solicitud</th>
            <th width="130">Folio</th>
            <th width="130">Zona</th>
            <th width="180">Gerente</th>
            <th width="180">Categoría</th>
            <th width="130">Tipo</th>
            <th width="140">Fanpage</th>
            <th width="110">Post</th>
            <th width="200">Opciones</th>
        </tr>
    </thead>
    <tbody align="center">
        {% for solicitud in solicitudes %}
        <tr>
            <td><input class="checkDownload" type="checkbox" name="checkbox" value="{{solicitud.id}}"></td>
            <td>{{ solicitud.fecha|date:"SHORT_DATE_FORMAT" }}</td>
            <td>{{solicitud.folio}}</td>
            <td>{{solicitud.zona}}</td>
            <td>{{solicitud.gerente}}</td>
            <td>{{solicitud.categoria}}</td>
            <td>{{solicitud.tipo}}</td>
            <td>{{solicitud.fanPage}}</td>
            <td>{{ solicitud.post|date:"SHORT_DATE_FORMAT" }}</td>
            <td>
                <div uk-lightbox="animation: scale">
                    {% for imagen in solicitud.imagenes_set.all %}
                    <a class="" href="/static/images/{{imagen.imagen}}" data-caption="{{imagen.nombre}}"></a>
                    {% endfor %}
                </div>
                <a href="#" class="open-lightbox"><i class="far fa-image"></i></a>
                {% comment %} <a href="{{solicitud.link}}" title="" target="_blank"><i class="fas fa-link"></i></a> {% endcomment %}
                <a href="#" title="" target="_blank"><i class="fas fa-link"></i></a>
                <a href="{% url 'usuarios:descarga_multi' solicitud.id %}" title=""><i class="fas fa-download"></i></a>
                <i class="far fa-edit"></i>
                <i class="fas fa-trash-alt"></i>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- tabla 01 ---------------------------------------->

{% endblock tablaDetalles %}

{% block javascript %}
{{ block.super }}
<script>
    (function () {
        var date = new Date();
        $('input[name="f_mes"]').val(date.getMonth()+1);
        $('input[name="f_anio"]').val(date.getFullYear());
        $('#download-factura').on('click', function(){
            $('#f_factura').submit();
        });

        $('#admin').DataTable({
            "lengthChange": true,
            "lengthMenu": [[5, 10, -1], [5, 10, "Todas"]],
            "info": false,
            "language": {
                "lengthMenu": "Mostrar _MENU_",
                "paginate": {
                    "next": "Siguiente",
                    "previous": "Anterior"
                },
                "zeroRecords": "Sin resultados",
                "search": "Filtrar :"
            }
        });
        $('select#id_zona').on('change', function () {
            let id_zona = $(this).val();
            if (id_zona.length > 0) {
                getFanpages(id_zona);
                getGerentes(id_zona);
            }
        });
    })();
    function getFanpages(id_zona) {
        clean("id_fanPage")
        $.ajax({
            method: "POST",
            url: "ajax/fp",
            beforeSend: function () {
                // preloader.className += ' active';
            },
            data: { csrfmiddlewaretoken: getCSRFTokenValue(), id_zona: id_zona }
        }).done(function (fanpages) {
            if (fanpages.length > 0) {
                addOptionsSelect(fanpages, "id_fanPage");
            }
        }).fail(function () {
            console.log('falló papá');
        });
    }
    function getGerentes(id_zona) {
        clean("id_gerente")
        $.ajax({
            method: "POST",
            url: "ajax/gr",
            beforeSend: function () {
                // preloader.className += ' active';
            },
            data: { csrfmiddlewaretoken: getCSRFTokenValue(), id_zona: id_zona }
        }).done(function (gerentes) {
            if (gerentes.length > 0) {
                addOptionsSelect(gerentes, "id_gerente");
            }
        }).fail(function () {
            console.log('falló papá');
        });
    }
    function clean(select_id) {
        $('#' + select_id).empty();
    }
    function addOptionsSelect(data, select_id) {
        data.forEach(element => {
            $('#' + select_id).append('<option value= ' + element.pk + ' >' + element.fields.nombre + '</option>');
        });
    }
    function getCSRFTokenValue() {
        var token = $('input[name="csrfmiddlewaretoken"]').val();
        return token;
    }
</script>
{% endblock javascript %}